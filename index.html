<!DOCTYPE html>
<html ng-app='app'>
  <head>
    <meta charset="UTF-8">
    <title>Resizing Machine</title>
    <link rel="stylesheet" href="css/style.css" media="screen" title="no title" charset="utf-8">
  </head>
  <body>
    <div class="dragover-zone">Drop your files here !</div>

    <div class="container-fluid">
      <app class=""></app>
    </div>

  </body>
</html>


<script>
  // You can also require other files to run in this process
  require('./renderer.js');


  const $ = require('jquery');
  const Jimp = require("jimp");

  function preventAll(event) {
    event.preventDefault();
    event.stopPropagation();
  }

  function log(text) {
    $('.logs .console').prepend('<span class="log">' + text + '</span>');
  }

  $("html").on("dragover", (e) => {
    preventAll(e);
    $('.dragover-zone').addClass('dragover');
  });

  $("html").on("dragleave", (e) => {
    preventAll(e);
  });

  $("html").on("dragleave", '.dragover-zone', (e) => {
    preventAll(e);
    $('.dragover-zone').removeClass('dragover');
  });

  $("html").on("drop", function(event) {
    $('.dragover-zone').removeClass('dragover');
    event.preventDefault();
    event.stopPropagation();
    const files = event.originalEvent.dataTransfer.files;
    const pathes = [];
    //log(files);
    for (let i = 0; i < files.length; i++) {
      pathes.push({
        path: files[i].path,
        name: files[i].name,
      });
    }
    doTheWork(pathes);
  });

  function doTheWork(images) {
    const options = angular.element($('#options-form')).scope().$ctrl.options;
    log('###');
    log('Processing files ...');
    images.forEach( (file, index) => {
      //log('file: ' + file.path);
      Jimp
        .read(file.path)
        .then((img) => {
          log('size: ' + img.bitmap.width + 'x' + img.bitmap.height);

          /* ROTATION */
          const rotation = parseInt(options.rotation);
          if (rotation !== 0) {
            log('Rotating image by ' + rotation + ' degrees');
            img.rotate(rotation);
          }

          /* RESIZING */
          if( options.size_choice === 'sizes') {// constrain image to given width and/or height
            log('Resizing by max width/height...');
            let max_width = img.bitmap.width;
            let max_height = img.bitmap.height;
            if (options.max_width) {
              log('Max width set (' + options.max_width_value + ')');
              max_width = parseInt(options.max_width_value);
            }
            if (options.max_height) {
              log('Max height set (' + options.max_height_value + ')');
              max_height = parseInt(options.max_height_value);
            }
            img.scaleToFit(max_width, max_height);
          } else if (options.size_choice === 'ratio') {
            let ratio = 1;
            if (parseFloat(options.ratio) < 1 && parseFloat(options.ratio) > 0) ratio = parseFloat(options.ratio);
            log('Resizing by ratio (' + ratio + ')');
            img.scale(ratio);
          }

          /* SAVING */
          let newPath = file.path;
          // output folder defined ?
          if (options.output_folder) {
            newPath = options.output_folder_value;
            if (newPath.lastIndexOf('/') !== newPath.length -1 || newPath.lastIndexOf('\\') !== newPath.length -1) {
              newPath += '/';
            }
            newPath += file.name;
          }
          const size = '' + img.bitmap.width + 'x' + img.bitmap.height;
          if (options.location === 'auto') {
            log('File name generated automatically');

            let newName = '' + Date.now() + '_' + size + '_' + file.name;
            newPath = file.path.replace(file.name, newName);
            //log('size: ' + img.bitmap.width + 'x' + img.bitmap.height);
          } else if (options.location === 'custom') {
            let newName = options.location_name;
            newName = newName.replace('[i]', index);
            newName = newName.replace('[time]', Date.now());
            newName = newName.replace('[size]', size);
            log('Custom file name: ' + newName);
            newPath = file.path.replace(file.name, newName);
          } // else we keep original name (override file)

          img.write(newPath, () => log('File saved (' + newPath + ')'));
        })
        .catch((err) => log(err));
    });
  }

</script>
